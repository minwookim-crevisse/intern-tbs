<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TBS - Supabase 연동 테스트</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #4A90E2;
        }

        h2 {
            color: #4A90E2;
            margin-top: 30px;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        input[type="text"],
        input[type="password"],
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: #4A90E2;
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
        }

        button {
            background-color: #4A90E2;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            background-color: #357ABD;
        }

        button.secondary {
            background-color: #6c757d;
        }

        button.secondary:hover {
            background-color: #545b62;
        }

        button.danger {
            background-color: #dc3545;
        }

        button.danger:hover {
            background-color: #c82333;
        }

        #log {
            background-color: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 3px 0;
        }

        .log-entry.error {
            color: #f48771;
        }

        .log-entry.success {
            color: #89d185;
        }

        .log-entry.info {
            color: #9cdcfe;
        }

        .user-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .user-info span {
            display: inline-block;
            margin-right: 20px;
        }

        .test-section {
            border: 1px solid #e9ecef;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>TBS Supabase 연동 테스트</h1>

        <!-- 연결 상태 -->
        <div id="connectionStatus" class="status info">
            Supabase 연결 상태를 확인하는 중...
        </div>

        <!-- 로그인 섹션 -->
        <div id="loginSection" class="test-section">
            <h2>1. 로그인 테스트</h2>
            <div class="form-group">
                <label>계정 ID</label>
                <input type="text" id="loginId" value="jahyun" placeholder="계정 ID">
            </div>
            <div class="form-group">
                <label>비밀번호</label>
                <input type="password" id="loginPassword" value="pass1" placeholder="비밀번호">
            </div>
            <button onclick="testLogin()">로그인</button>
            <button onclick="testLogout()" class="secondary">로그아웃</button>
            <button onclick="checkCurrentUser()" class="secondary">현재 사용자 확인</button>
        </div>

        <!-- 사용자 정보 -->
        <div id="userInfo" class="user-info hidden">
            <strong>현재 사용자:</strong>
            <span id="currentUserId">-</span>
            <span id="currentUserName">-</span>
            <span id="currentUserRole">-</span>
        </div>

        <!-- 문제 조회 섹션 -->
        <div id="problemSection" class="test-section">
            <h2>2. 문제 조회 테스트</h2>
            <button onclick="testGetProblems()">문제 목록 조회</button>
            <button onclick="testGetProblem(1)">문제 1 조회</button>
            <button onclick="testGetProblem(2)">문제 2 조회</button>
        </div>

        <!-- 제출 테스트 섹션 -->
        <div id="submissionSection" class="test-section">
            <h2>3. 답안 저장/제출 테스트</h2>
            <div class="form-group">
                <label>문제 ID</label>
                <input type="text" id="testProblemId" value="1" placeholder="문제 ID">
            </div>
            <div class="form-group">
                <label>답안 내용</label>
                <textarea id="testAnswer" rows="3" placeholder="테스트 답안 내용">테스트 답안입니다.</textarea>
            </div>
            <button onclick="testSaveAnswer()">임시 저장</button>
            <button onclick="testCheckSubmission()">제출 상태 확인</button>
            <button onclick="testGetSubmission()">제출 데이터 조회</button>
            <button onclick="testSubmitAnswer()" class="danger">최종 제출 (주의!)</button>
        </div>

        <!-- 관리자 테스트 섹션 -->
        <div id="adminSection" class="test-section">
            <h2>4. 관리자 기능 테스트</h2>
            <button onclick="testGetCandidateList()">후보자 목록</button>
            <button onclick="testGetAllSubmissions()">전체 제출 현황</button>
            <button onclick="testGetWeaknessStats()">취약점 통계</button>
            <div class="form-group" style="margin-top: 15px;">
                <label>채점할 후보자 ID</label>
                <input type="text" id="gradeUserId" value="jahyun" placeholder="후보자 ID">
            </div>
            <button onclick="testSaveGrade()">채점 저장 (85점)</button>
            <button onclick="testGetCandidateDetail()">후보자 상세 조회</button>
        </div>

        <!-- 로그 출력 -->
        <h2>실행 로그</h2>
        <div id="log"></div>
        <button onclick="clearLog()" class="secondary" style="margin-top: 10px;">로그 지우기</button>
    </div>

    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- TBS Supabase Backend -->
    <script src="supabase-backend.js"></script>

    <script>
        // 로그 함수
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // 연결 상태 업데이트
        function updateConnectionStatus(success, message) {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.className = `status ${success ? 'success' : 'error'}`;
            statusDiv.textContent = message;
        }

        // 사용자 정보 업데이트
        function updateUserInfo(user) {
            const infoDiv = document.getElementById('userInfo');
            if (user) {
                infoDiv.classList.remove('hidden');
                document.getElementById('currentUserId').textContent = `ID: ${user.id}`;
                document.getElementById('currentUserName').textContent = `이름: ${user.name}`;
                document.getElementById('currentUserRole').textContent = `권한: ${user.role}`;
            } else {
                infoDiv.classList.add('hidden');
            }
        }

        // 초기화
        document.addEventListener('DOMContentLoaded', async function() {
            log('페이지 로드 완료');

            // Supabase 연결 확인
            if (typeof supabase !== 'undefined') {
                log('Supabase 라이브러리 로드 완료', 'success');
                TBSSupabase.init();
                updateConnectionStatus(true, 'Supabase 연결 성공');

                // 기존 세션 확인
                const user = await TBSSupabase.auth.getCurrentUser();
                if (user) {
                    log(`기존 세션 발견: ${user.id} (${user.name})`, 'success');
                    updateUserInfo(user);
                } else {
                    log('로그인이 필요합니다', 'info');
                }
            } else {
                log('Supabase 라이브러리 로드 실패', 'error');
                updateConnectionStatus(false, 'Supabase 라이브러리를 로드할 수 없습니다');
            }
        });

        // 로그인 테스트
        async function testLogin() {
            const id = document.getElementById('loginId').value;
            const password = document.getElementById('loginPassword').value;

            log(`로그인 시도: ${id}`);

            try {
                const result = await TBSSupabase.auth.login(id, password);
                if (result.success) {
                    log(`로그인 성공: ${result.user.name} (${result.user.role})`, 'success');
                    updateUserInfo(result.user);
                } else {
                    log(`로그인 실패: ${result.message}`, 'error');
                }
            } catch (err) {
                log(`로그인 오류: ${err.message}`, 'error');
            }
        }

        // 로그아웃 테스트
        async function testLogout() {
            log('로그아웃 시도');
            try {
                const result = await TBSSupabase.auth.logout();
                log(result.message, 'success');
                updateUserInfo(null);
            } catch (err) {
                log(`로그아웃 오류: ${err.message}`, 'error');
            }
        }

        // 현재 사용자 확인
        async function checkCurrentUser() {
            log('현재 사용자 확인');
            try {
                const user = await TBSSupabase.auth.getCurrentUser();
                if (user) {
                    log(`현재 사용자: ${JSON.stringify(user)}`, 'success');
                    updateUserInfo(user);
                } else {
                    log('로그인된 사용자 없음', 'info');
                    updateUserInfo(null);
                }
            } catch (err) {
                log(`조회 오류: ${err.message}`, 'error');
            }
        }

        // 문제 목록 조회
        function testGetProblems() {
            log('문제 목록 조회');
            const problems = TBSSupabase.problems.getAll();
            log(`총 ${problems.length}개 문제:`, 'success');
            problems.forEach(p => {
                log(`  - [${p.id}] ${p.title}`);
            });
        }

        // 특정 문제 조회
        function testGetProblem(id) {
            log(`문제 ${id} 조회`);
            const problem = TBSSupabase.problems.get(id);
            if (problem) {
                log(`제목: ${problem.title}`, 'success');
                log(`참고자료: ${problem.references.length}개`);
            } else {
                log('문제를 찾을 수 없습니다', 'error');
            }
        }

        // 답안 저장 테스트
        async function testSaveAnswer() {
            const problemId = parseInt(document.getElementById('testProblemId').value);
            const answer = document.getElementById('testAnswer').value;

            log(`답안 저장: 문제 ${problemId}`);
            try {
                const result = await TBSSupabase.submissions.save(problemId, answer, '1-1');
                log(result.message, result.success ? 'success' : 'error');
            } catch (err) {
                log(`저장 오류: ${err.message}`, 'error');
            }
        }

        // 제출 상태 확인
        async function testCheckSubmission() {
            const problemId = parseInt(document.getElementById('testProblemId').value);
            log(`제출 상태 확인: 문제 ${problemId}`);
            try {
                const isSubmitted = await TBSSupabase.submissions.isSubmitted(problemId);
                log(`제출 여부: ${isSubmitted ? '제출됨' : '미제출'}`, isSubmitted ? 'info' : 'success');
            } catch (err) {
                log(`확인 오류: ${err.message}`, 'error');
            }
        }

        // 제출 데이터 조회
        async function testGetSubmission() {
            const problemId = parseInt(document.getElementById('testProblemId').value);
            log(`제출 데이터 조회: 문제 ${problemId}`);
            try {
                const submission = await TBSSupabase.submissions.get(problemId);
                if (submission) {
                    log(`데이터: ${JSON.stringify(submission, null, 2)}`, 'success');
                } else {
                    log('제출 데이터 없음', 'info');
                }
            } catch (err) {
                log(`조회 오류: ${err.message}`, 'error');
            }
        }

        // 최종 제출 테스트
        async function testSubmitAnswer() {
            if (!confirm('정말 제출하시겠습니까? 제출 후에는 다시 볼 수 없습니다.')) {
                return;
            }

            const problemId = parseInt(document.getElementById('testProblemId').value);
            const answer = document.getElementById('testAnswer').value;

            log(`최종 제출: 문제 ${problemId}`);
            try {
                const result = await TBSSupabase.submissions.submit(problemId, answer, '1-1');
                log(result.message, result.success ? 'success' : 'error');
            } catch (err) {
                log(`제출 오류: ${err.message}`, 'error');
            }
        }

        // 후보자 목록 조회
        async function testGetCandidateList() {
            log('후보자 목록 조회');
            try {
                const candidates = await TBSSupabase.admin.getCandidateList();
                log(`총 ${candidates.length}명:`, 'success');
                candidates.forEach(c => {
                    log(`  - ${c.name} (${c.id}): 제출 ${c.submittedCount}/${c.totalProblems}, 평균 ${c.averageScore || '-'}점`);
                });
            } catch (err) {
                log(`조회 오류: ${err.message}`, 'error');
            }
        }

        // 전체 제출 현황
        async function testGetAllSubmissions() {
            log('전체 제출 현황 조회');
            try {
                const submissions = await TBSSupabase.admin.getAllSubmissions();
                log(`총 ${submissions.length}건:`, 'success');
                submissions.forEach(s => {
                    log(`  - ${s.userId} / 문제${s.problemId}: ${s.isSubmitted ? '제출완료' : '임시저장'}`);
                });
            } catch (err) {
                log(`조회 오류: ${err.message}`, 'error');
            }
        }

        // 취약점 통계
        async function testGetWeaknessStats() {
            log('취약점 통계 조회');
            try {
                const stats = await TBSSupabase.admin.getWeaknessStats();
                const entries = Object.entries(stats);
                if (entries.length > 0) {
                    log(`취약점 통계:`, 'success');
                    entries.forEach(([tag, count]) => {
                        log(`  - ${tag}: ${count}건`);
                    });
                } else {
                    log('채점 데이터 없음', 'info');
                }
            } catch (err) {
                log(`조회 오류: ${err.message}`, 'error');
            }
        }

        // 채점 저장 테스트
        async function testSaveGrade() {
            const userId = document.getElementById('gradeUserId').value;
            log(`채점 저장: ${userId} / 문제1 / 85점`);
            try {
                const result = await TBSSupabase.admin.saveGrade(
                    userId,
                    1,
                    85,
                    ['계산 오류', '참고자료 미활용'],
                    '전반적으로 양호하나 일부 계산 오류가 있습니다.'
                );
                log(result.message, result.success ? 'success' : 'error');
            } catch (err) {
                log(`저장 오류: ${err.message}`, 'error');
            }
        }

        // 후보자 상세 조회
        async function testGetCandidateDetail() {
            const userId = document.getElementById('gradeUserId').value;
            log(`후보자 상세 조회: ${userId}`);
            try {
                const detail = await TBSSupabase.admin.getCandidateDetail(userId);
                if (detail) {
                    log(`이름: ${detail.name}`, 'success');
                    log(`문제별 현황:`);
                    detail.problems.forEach(p => {
                        log(`  - 문제${p.problemId}: ${p.submitted ? '제출' : '미제출'}, 점수: ${p.score || '-'}`);
                    });
                } else {
                    log('후보자를 찾을 수 없습니다', 'error');
                }
            } catch (err) {
                log(`조회 오류: ${err.message}`, 'error');
            }
        }
    </script>
</body>
</html>
